# üß™ **Management Review & CAPA Testing Guide**

## ‚úÖ **System Status**

```
‚úÖ All migrations applied (9/9)
‚úÖ Seed data loaded (8 types, 8 templates, 185 questions)
‚úÖ Weights distributed and validated
‚úÖ No system check issues
‚úÖ No linter errors
‚úÖ Reminder command working
‚úÖ All routes configured
‚úÖ Frontend components built
```

**Status: READY FOR TESTING** üéâ

---

## üéØ **Test Scenarios**

### **Test 1: Complete Workflow (Recommended First Test)**

#### **Step 1: Log a Finding**
```
URL: http://localhost:5173/audit/findings

1. Click "Log Finding" button
2. Select an existing audit plan (or create one first)
3. Add attendees: "John Doe, Jane Smith"
4. Select audit date: Today
5. Answer questions:
   - Expand each category
   - Select compliance status for each question
   - Watch score update in real-time
6. Mark at least 2-3 questions as "MAJOR_NC" or "MINOR_NC"
7. Observe the overall score (should be Amber or Red)
8. Click "Submit Finding"

Expected Result:
‚úÖ Finding created: FND-2025-XXXX
‚úÖ Score shows in color-coded box
‚úÖ Success message appears
‚úÖ Redirects to findings list
```

#### **Step 2: Review in Management Review**
```
URL: http://localhost:5173/audit/management-review

1. Observe the dashboard:
   - Summary cards show counts
   - Major NCs card (should show 0 or more)
   - Minor NCs card (should show 0 or more)
   - "Need CAPA" card (should match NCs)

2. Findings table shows:
   - Your finding is listed
   - Finding code displayed
   - Type chip (Major NC / Minor NC)
   - Severity chip with color
   - CAPA column shows ‚ùå "Need" icon
   - Actions column has buttons

3. Apply filters:
   - Try filtering by Status: "OPEN"
   - Try filtering by Type: "MAJOR_NC"
   - Table updates instantly

Expected Result:
‚úÖ Finding visible in table
‚úÖ Shows "Needs CAPA" indicator
‚úÖ Filters work correctly
‚úÖ Summary cards show correct counts
```

#### **Step 3: Assign CAPA**
```
Still on: http://localhost:5173/audit/management-review

1. Find your finding in the table
2. Click the üîµ "Assign CAPA" button
3. Quick CAPA Assignment dialog opens

Observe the dialog:
‚úÖ Finding details box at top (code, type, severity)
‚úÖ Title field PRE-FILLED: "CAPA: [finding title]"
‚úÖ Description PRE-FILLED from finding
‚úÖ Root cause PRE-FILLED (if available)
‚úÖ Priority PRE-SET based on severity
‚úÖ Target Date PRE-CALCULATED (14 days for Major NC)

4. Fill remaining fields:
   - Action Plan: "1. Review procedure\n2. Implement changes\n3. Verify"
   - Responsible Person: Select from dropdown
   - Adjust target date if needed

5. Click "Assign CAPA"

Expected Result:
‚úÖ Dialog closes
‚úÖ Success message: "CAPA(s) assigned successfully"
‚úÖ Finding row updates - CAPA column shows ‚úÖ
‚úÖ Console shows email notification (if email configured)
‚úÖ Table refreshes automatically
```

#### **Step 4: View CAPA**
```
URL: http://localhost:5173/audit/capas

1. Open CAPA Management page
2. Click "My CAPAs" tab (if you assigned to yourself)

Observe the CAPA card:
‚úÖ Action code: CAPA-2025-XXXX
‚úÖ Title shown
‚úÖ Priority chip with color
‚úÖ Progress bar (0%)
‚úÖ Finding code (BLUE, CLICKABLE) üëà Test this!
‚úÖ Responsible person name
‚úÖ Target date with countdown
‚úÖ Deadline color:
   - Green if >7 days
   - Yellow if 3-7 days
   - Orange if 1-2 days
   - Red if overdue

3. Click the finding code link
4. New tab opens ‚Üí Findings page

Expected Result:
‚úÖ CAPA displays correctly
‚úÖ Finding link works (opens findings page)
‚úÖ All data matches what you entered
‚úÖ Deadline countdown accurate
```

#### **Step 5: Test Bulk Assignment**
```
URL: http://localhost:5173/audit/management-review

1. If you have multiple findings needing CAPA:
   - Check the checkboxes for 2-3 findings
   - "Assign CAPA to Selected (3)" button appears
   - Click the button
   - Bulk assignment dialog opens

2. Fill the form:
   - Action plan (same for all)
   - Responsible person
   - Target date

3. Submit

Expected Result:
‚úÖ Multiple CAPAs created (one per finding)
‚úÖ All show in CAPA Management
‚úÖ Multiple email notifications sent
‚úÖ All findings updated
```

---

### **Test 2: Deadline Tracking**

#### **Create a CAPA Due Soon**
```
URL: http://localhost:5173/audit/management-review

1. Create a finding (if you don't have one)
2. Assign CAPA
3. In the dialog, set target date = TOMORROW
4. Submit

Expected Result:
‚úÖ CAPA created with 1-day deadline

5. Go to CAPA Management
6. Observe the CAPA card:
   - Deadline should show "1 day" in RED or ORANGE
   - Visual urgency indicator

Test Command:
docker compose exec web python manage.py send_capa_reminders

Expected Console Output:
üö® URGENT: CAPA-2025-XXXX (due tomorrow!)
üìß Total reminders sent: 1

‚úÖ Email template shown in console
```

---

### **Test 3: Email Notifications**

```bash
# Send CAPA reminders
docker compose exec web python manage.py send_capa_reminders

Expected Output:
‚úÖ Shows all CAPAs checked
‚úÖ Sends reminders for:
   - Overdue CAPAs (if any)
   - Due in 7 days or less
   - Due tomorrow (URGENT)
‚úÖ Console shows email content
‚úÖ Recipients listed

If SMTP configured:
‚úÖ Real emails sent
‚úÖ Check recipient inbox
‚úÖ Email has:
   - CAPA details
   - Finding link
   - Deadline info
   - Action required
```

---

### **Test 4: Progress Updates**

```
URL: http://localhost:5173/audit/capas

1. Open a CAPA card
2. Click "Update Progress"
3. Dialog opens:
   - Progress slider (0-100%)
   - Update text field
   - Challenges field
   - Next steps field

4. Update to 50%
5. Add text: "Completed training review"
6. Submit

Expected Result:
‚úÖ Progress bar updates to 50%
‚úÖ Card shows new progress
‚úÖ Update recorded

7. Update to 100%
8. Status changes to "PENDING_VERIFICATION"
9. "Submit for Verification" button appears

Expected Result:
‚úÖ CAPA marked complete
‚úÖ Ready for HSSE Manager review
```

---

### **Test 5: Filtering & Search**

```
URL: http://localhost:5173/audit/management-review

1. Create multiple findings:
   - 2 Major NCs
   - 3 Minor NCs
   - 2 Observations

2. Test filters:
   - Status: "OPEN" ‚Üí Shows only open
   - Severity: "HIGH" ‚Üí Shows only high
   - Type: "MAJOR_NC" ‚Üí Shows only Major NCs

Expected Result:
‚úÖ Each filter works independently
‚úÖ Table updates instantly
‚úÖ Summary cards update
‚úÖ "X findings | Y need CAPA" text updates
```

---

### **Test 6: Admin Editing**

```
URL: http://localhost:8000/admin/

1. Login as admin
2. Navigate to: Audits ‚Üí Audit Checklist Templates
3. Click "System Audit"
4. Scroll to "Audit Checklist Categories"
5. Expand a category
6. Click a question
7. Edit the question text
8. Save

9. Return to frontend
10. Log a new finding
11. Select System Audit
12. Verify your edited question appears

Expected Result:
‚úÖ Question text updated
‚úÖ Changes reflect in frontend immediately
‚úÖ Weight still valid

Test Weight Validation:
docker compose exec web python manage.py validate_weights

Expected Output:
‚úÖ All templates: weights valid
‚úÖ All categories: weights valid
‚úÖ No errors
```

---

### **Test 7: PDF Report**

```
URL: http://localhost:5173/audit/findings

1. Find a finding with responses
2. Click the üìÑ "Download PDF" button

Expected Result:
‚úÖ PDF downloads
‚úÖ Opens in new tab/browser
‚úÖ Contains:
   - Finding details
   - Audit information
   - All question responses
   - Compliance status
   - Score breakdown
   - CAPA information (if assigned)
   - Professional formatting
```

---

### **Test 8: Finding Link from CAPA**

```
URL: http://localhost:5173/audit/capas

1. Open any CAPA
2. Observe the "Finding: FND-2025-XXXX" line
3. It should be BLUE and CLICKABLE
4. Click it

Expected Result:
‚úÖ Opens findings page in new tab
‚úÖ Shows the related finding
‚úÖ Can view full finding details
```

---

## üìä **Verification Checklist**

### **Management Review Page:**
- [ ] Summary cards display correct counts
- [ ] Findings table shows all findings
- [ ] Filters work (status, severity, type)
- [ ] Color coding correct (severity, type)
- [ ] "Needs CAPA" indicators visible
- [ ] "Assign CAPA" button works
- [ ] Bulk selection works
- [ ] "Assign to Selected" button appears

### **Quick CAPA Assignment:**
- [ ] Dialog opens when clicked
- [ ] Finding details box shows correct info
- [ ] Title pre-filled from finding
- [ ] Description pre-filled
- [ ] Root cause pre-filled
- [ ] Priority auto-set from severity
- [ ] Target date auto-calculated
- [ ] Suggested timeline shown
- [ ] Compliance guidelines visible
- [ ] Submit creates CAPA
- [ ] Email notification sent

### **CAPA Management:**
- [ ] CAPA cards display
- [ ] Finding code is clickable
- [ ] Clicking opens findings page
- [ ] Progress bar visible
- [ ] Deadline countdown shown
- [ ] Color coding correct:
  - [ ] Green: >7 days
  - [ ] Yellow: 3-7 days
  - [ ] Orange: 1-2 days
  - [ ] Red: Overdue
- [ ] "Update Progress" works
- [ ] Status changes when 100%

### **Email System:**
- [ ] Reminder command runs
- [ ] Console shows email content
- [ ] Recipients correct
- [ ] 7-day warnings work
- [ ] 1-day urgent works
- [ ] Overdue escalations work

### **Admin Interface:**
- [ ] Can edit questions
- [ ] Can add questions
- [ ] Can adjust weights
- [ ] Changes reflect immediately
- [ ] Weight validation works

### **PDF Generation:**
- [ ] Download button works
- [ ] PDF displays correctly
- [ ] All data included
- [ ] Professional formatting

---

## üêõ **Troubleshooting**

### **Issue: Management Review page is blank**
```
Check:
1. Are there any findings?
   ‚Üí Log a finding first
2. Console errors?
   ‚Üí Open browser DevTools
3. API endpoint working?
   ‚Üí Check: http://localhost:8000/api/v1/audits/findings/
```

### **Issue: "Assign CAPA" button doesn't appear**
```
Check:
1. Is finding type Major NC or Minor NC?
   ‚Üí Only NCs need CAPA
2. Does finding already have CAPA?
   ‚Üí Can only assign once
3. Are you HSSE Manager?
   ‚Üí Only managers can assign
```

### **Issue: Finding link not clickable**
```
Check:
1. Is text blue?
   ‚Üí Should be blue and underlined on hover
2. Does it open anything?
   ‚Üí Should open findings page in new tab
3. Console errors?
   ‚Üí Check browser console
```

### **Issue: No reminders sent**
```
Check:
1. Are there any CAPAs?
   ‚Üí Create CAPAs first
2. Are deadlines approaching?
   ‚Üí Set target date = tomorrow to test
3. Command output?
   ‚Üí Should show "X reminders sent"
```

### **Issue: Weights don't sum to 100%**
```
Fix:
docker compose exec web python manage.py auto_distribute_weights
docker compose exec web python manage.py validate_weights

Should show: ‚úÖ All weights valid
```

---

## ‚úÖ **Expected Results Summary**

After completing all tests, you should have:

1. **Findings logged** with real-time scores ‚úÖ
2. **Management Review page** showing all findings ‚úÖ
3. **CAPAs assigned** from findings ‚úÖ
4. **Finding-CAPA links** working ‚úÖ
5. **Deadline tracking** with color coding ‚úÖ
6. **Email reminders** configured ‚úÖ
7. **Progress updates** recorded ‚úÖ
8. **PDF reports** generated ‚úÖ
9. **Admin editing** working ‚úÖ
10. **Filters** functioning ‚úÖ

**All features operational!** üéâ

---

## üöÄ **Quick Smoke Test (5 minutes)**

```bash
# 1. Check system
docker compose exec web python manage.py check
# Expected: ‚úÖ No issues

# 2. Check data
docker compose exec web python manage.py shell -c "
from audits.models import *
print('‚úÖ Types:', AuditType.objects.count())
print('‚úÖ Templates:', AuditChecklistTemplate.objects.count())
print('‚úÖ Questions:', AuditChecklistQuestion.objects.count())
"
# Expected: 8, 8, 185

# 3. Test reminder
docker compose exec web python manage.py send_capa_reminders
# Expected: ‚úÖ Reminder job complete

# 4. Open frontend
# http://localhost:5173/audit/management-review
# Expected: Page loads, no errors

# 5. Create finding ‚Üí Assign CAPA ‚Üí View CAPA ‚Üí Click finding link
# Expected: Complete workflow works
```

**If all pass: SYSTEM READY! üéâ**

---

## üìû **Support**

### **Common Questions:**

**Q: Can I edit questions after findings are logged?**
A: Yes! Changes reflect immediately, but existing findings keep their data.

**Q: Can I change weights?**
A: Yes, via admin. Run `validate_weights` after changes.

**Q: How do I schedule automatic reminders?**
A: Add to cron:
```
0 9 * * * cd /path && docker compose exec web python manage.py send_capa_reminders
```

**Q: Can I assign one CAPA to multiple findings?**
A: No, one CAPA per finding. Use bulk assignment for efficiency.

**Q: What if CAPA deadline needs extension?**
A: Update target date in CAPA Management (future enhancement).

---

## üéâ **READY TO TEST!**

**Start here:**
http://localhost:5173/audit/management-review

**Complete workflow:**
1. Log Finding (3 min)
2. Review in Management Review (1 min)
3. Assign CAPA (2 min)
4. Check CAPA Management (1 min)
5. Test reminder command (1 min)

**Total: 8 minutes to verify complete system!** ‚è±Ô∏è

**Everything is ready!** üöÄüéâ‚ú®

